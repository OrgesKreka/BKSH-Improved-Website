<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./vendors/bulma/bulma.min.css">
    <link rel="stylesheet" href="./vendors/bulma/bulma-tooltip.min.css">
    <link rel="stylesheet" href="./resources/style.css">
    <link rel="stylesheet" href="./vendors/bulma/bulma-pageloader.css">
    <script src="./vendors/font-awesome/all.min.js"></script>
    <link rel="stylesheet" href="./vendors/font-awesome/all.min.css" />
    <script src="./vendors/jquery/jquery.js"></script>
    <script src="./vendors/FlowType-JS/flow-type.js"></script>
    <script src="./resources/script.js"></script>
    <title>Bibloteka Kombëtare - Katalogët Online</title>
</head>

<body cz-shortcut-listener="true" class="Site">

    <!-- Loader -->
    <div class="pageloader"><span class="title">Duke kërkuar...</span></div>

    <div class="Site-content">
        <div style="margin-top: 7%"></div>

        <div style="text-align: center;">
            <a href="http://www.bksh.al/" target="_blank" style="display: inline-block;">
                <img src="./resources/images/Banner.png" height="200px" width="600px">
            </a>
            <br>
        </div>

        <div class="content column is-half is-offset-one-quarter" style="margin-top: 30px">
            <form id="input-form">

                <div class="field">
                    <div class="control has-icons-left has-tooltip-success has-tooltip-multiline has-tooltip-arrow"
                        data-tooltip="Në këtë fushë mund të shkruani fjalë nga titulli. Nëse shkruani më shumë se një fjalë, do të shfaqen të gjitha regjistrimet që përmbajnë këto fjalë, pavarësisht nga renditja e tyre në titull.">
                        <input class="input is-medium" type="search" placeholder="Kërko me titull" id='title-search'>
                        <span class="icon is-medium is-left">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>

                <div class="field">
                    <div class="control has-icons-left has-tooltip-success  has-tooltip-multiline has-tooltip-arrow"
                        data-tooltip="Në këtë fushë mund të shkruani mbiemrin ose mbiemrin dhe emrin e autorit që doni të gjeni (p.sh. 'frashëri' ose 'frashëri, naim').">
                        <input class="input is-medium" type="search" placeholder="Kërko me Autor" id="author-search">
                        <span class="icon is-medium is-left">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>

                <div class="field">
                    <div class="control has-icons-left has-tooltip-success  has-tooltip-multiline has-tooltip-arrow"
                        data-tooltip="Në këtë fushë mund të shkruani fjalë që u përkasin fushave të ndryshme. Renditja e fjalëve nuk është e rëndësishme.">
                        <input class="input is-medium" type="search" placeholder="Kërko me tekst" id="text-search">
                        <span class="icon is-medium is-left">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>

                <div class="field">
                    <div class="control has-icons-left has-tooltip-success  has-tooltip-multiline has-tooltip-arrow"
                        data-tooltip="Këtu mund të shkruani subjekte për të cilat jeni të interesuar. Fusha plotësohet sipas listës së subjekteve të Bibliotekës Kombëtare. Edhe në këtë rast mund të përdoret tronkimi (këputja) i fjalëve. Një shembull për bazën tonë të të dhënave mund të jetë: 'kom', nga ky kërkim mund të gjejmë 'kombi', por gjithashtu 'kompiuter'.">
                        <input class="input is-medium" type="search" placeholder="Kërko me fjalë kyçe"
                            id="keyword-search">
                        <span class="icon is-medium is-left">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>

                <div class="field">
                    <div class="control has-icons-left has-tooltip-success  has-tooltip-multiline has-tooltip-arrow"
                        data-tooltip="Këtu mund të shkruani vitin e botimit.">
                        <input class="input is-medium" type="number" min="900" max="2099" placeholder="Kërko me vit"
                            id="year-search">
                        <span class="icon is-medium is-left">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>

                <input type="submit" style="position: absolute; left: -9999px; width: 1px; height: 1px;"
                    tabindex="-1" />
            </form>
        </div>

        <div class="column is-half is-offset-one-quarter has-tooltip-success  has-tooltip-multiline has-tooltip-arrow"
            id="database-source"
            data-tooltip="Në këtë fushë mund të zgjidhni bazën e të dhënave në të cilën doni të kërkoni. Klikoni shigjetën pas listës së bazave të të dhënave dhe zgjidhni njërën prej tyre.
        Mund të kërkoni në pjesën e zgjedhur të katalogut ose në katalogun e plotë.
        Lutemi të kini parasysh që katalogu ynë pasurohet në vijimësi me tituj të botimeve të reja që hyjnë në koleksionet tona; ndërsa informacionin bibliografik për botimet më të vjetra mund ta gjeni në skedarin tradicional me skeda. ">
            <div class="tabs is-centered">
                <ul>
                    <li class="search-tab is-active" onclick="switchTab(this)" value="books"><a>Libra</a></li>
                    <li class="search-tab" onclick="switchTab(this)" value="articles"><a>Artikuj</a></li>
                    <li class="search-tab" onclick="switchTab(this)" value="avm"><a>Materiale Audiovisuale</a></li>
                    <li class="search-tab" onclick="switchTab(this)" value="serials"><a>Periodikë</a></li>
                    <li class="search-tab" onclick="switchTab(this)" value="map"><a>Harta</a></li>
                    <li class="search-tab" onclick="switchTab(this)" value="thesis"><a>Disertacione</a></li>
                    <li class="search-tab" onclick="switchTab(this)" value="all"><a>Të Gjitha</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!--   Error Div  -->
    <div id="content" class="tile is-ancestor is-12">
        <div class="tile is-vertical is-2"></div>
        <div class="tile is-vertical is-8">

            <div class="notification is-danger error-notification is-child" id="error-message"></div>

            <div class="header tile column"></div>
            <div class="tile is-parent is-vertical">
                <div class="tile is-child" id="result"></div>
            </div>
        </div>
        <div class="tile is-vertical is-2"></div>
    </div>

    <!--   Modal Info  -->
    <div class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <button class="modal-close is-large" aria-label="close" onclick="closeModalForm()"></button>
            <section class="modal-card-body">
                <div class="content">
                    <div class="card">
                        <div class="card-content">
                            <div class="media">
                                <div class="media-left">
                                    <figure class="image is-128x128">
                                        <img src="./resources/images/first-post.png" alt="Placeholder image">
                                    </figure>
                                </div>
                                <div class="media-content">
                                    <p class="title is-3" id='info-title'></p>
                                    <br>
                                    <p class="subtitle is-6" id="info-isbn"></p>
                                </div>
                            </div>

                            <div class="content">
                                <div class="list"></div>

                                <div class="card">
                                    <header class="card-header">
                                        <p class="card-header-title">
                                            Te dhëna specifike
                                        </p>
                                        <a class="card-header-icon" aria-label="more options"
                                            onclick="toggleIsHidden()">
                                            <span class="icon">
                                                <i class="fas fa-angle-down" aria-hidden="true"></i>
                                            </span>
                                        </a>
                                    </header>

                                    <div class="card-content is-collapsible is-hidden">

                                        <p id='info-publish' class="is-hidden"> </p>
                                        <p id='info-physical-data' class="is-hidden"></p>
                                        <p id="info-notes" class="is-hidden"> </p>
                                        <p id='info-clasification' class="is-hidden"></p>
                                        <p id='info-serie-title' class="is-hidden"></p>
                                        <p id="info-number" class="is-hidden"></p>

                                        <p id="info-keywords" class="is-hidden"></p>
                                    </div>
                                </div>

                                <br />
                                <div id="table-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
            </footer>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="column is-half is-offset-one-quarter">
            <div class="columns is-vcentered">
                <a class="column " href="https://sq.wikipedia.org/wiki/Biblioteka_Komb%C3%ABtare" target="_blank">
                    Rreth BKSH
                </a>

                <a class="column " href="https://github.com/OrgesKreka/BKSH-Improved-Website" target="_blank">
                    Projekti në Github
                </a>

                <a class="column  " href="https://www.facebook.com/orges.kreka" target="_blank">
                    Profili im në facebook
                </a>

            </div>
        </div>
    </footer>
</body>

<script>

    const url = "http://bksh-improved-website.gearhostpreview.com/api";


    $(function () {
        $('#input-form').on("submit", processForm);

    });

    function resetTabs() {
        var tabs = document.getElementsByClassName("search-tab");
        var i;
        for (i = 0; i < tabs.length; i++) {
            var tab = tabs[i];
            if (tab.classList.contains('is-active')) {
                tab.classList.remove('is-active');
            }
        }
    }

    function switchTab(element) {
        resetTabs();
        element.classList.toggle('is-active');
    }

    function processForm(e) {
        if (e.preventDefault) e.preventDefault;

        var database = $('ul > li.is-active').first().attr('value');
        var title = $('#title-search').val();
        var author = $('#author-search').val();
        var text = $('#text-search').val();
        var keyWord = $('#keyword-search').val();
        var year = $('#year-search').val();

        var errorDiv = $('#error-message');
        if (!errorDiv.hasClass('error-notification'))
            errorDiv.addClass('error-notification');

        errorDiv.empty();


        var resultsDiv = $('#result');
        var header = $('.header');

        resultsDiv.empty();
        header.empty();

        var isFormEmpty = true;

        if (Boolean(title))
            isFormEmpty = false;

        if (Boolean(author))
            isFormEmpty = false;

        if (Boolean(text))
            isFormEmpty = false;

        if (Boolean(keyWord))
            isFormEmpty = false;

        if (Boolean(year))
            isFormEmpty = false;

        if (isFormEmpty) {
            errorDiv.append("<strong>" + "Please, fill at least one of the search fields." + "</strong>");
            errorDiv.toggleClass('error-notification');
            return false;
        }

        var loader = $('.pageloader').first();
        loader.toggleClass('is-active');



        $.ajax({
            url: url + '/Book/GetSearchResults',
            type: 'POST',
            data: {
                "title": title,
                "author": author,
                "text": text,
                "keyword": keyWord,
                "year": year,
                "database": database
            },
            headers: {
                "Accept": "application/json",
            },
            success: function (data, textStatus, xhr) {

                $.each(data, function (index, item) {


                    var div = "<div class= 'column'>"
                        + "<div class='card'>"
                        + "<header class='card-header'>"
                        + "<p class='card-header-title'>"
                        + "<a onclick=\"showDetails('" + item.bookInfoUrl + "')\">" + "<b class='tag is-success'>" + (index + 1) + " </b> " + item.title + "</a>"
                        + "</p>"
                        + "</header>"
                        + "<div class='card-content'>"
                        + "<div class='content'>"
                        + "<h4>" + (item.authors.length > 0 ? item.authors : "-") + "</h4>"
                        + "</div>"
                        + "</div>"
                        + "</div>"
                        + "</div>";
                    resultsDiv.append(div);
                });

                header.append("<h3 class='title is-3 is-spaced'>" + data.length + " Rezultate </h3>");
                gotoHash('#content');

            },
            error: function (xhr, status, error) {
                if (xhr.status == 404 || xhr.status == 0) {
                    errorDiv.append("<strong>" + "Couldn't reach API url" + "</strong>");
                }
                else {
                    errorDiv.append("<strong>" + xhr.responseText + "</strong>");
                }

                errorDiv.toggleClass('error-notification');
            },
            complete: function () {
                loader.removeClass('is-active');
            }
        });

        return false; // to prevent the default form behavior
    }

    function gotoHash(hash) {
        $('html, body').animate({ scrollTop: $(hash).offset().top }, 'slow');
    }

    function showDetails(infoUrl) {
        var errorDiv = $('#error-message');
        if (!errorDiv.hasClass('error-notification'))
            errorDiv.addClass('error-notification');

        errorDiv.empty();

        if (!$('.is-collapsible').hasClass('is-hidden'))
            toggleIsHidden();

        var loader = $('.pageloader').first();
        loader.toggleClass('is-active');

        var contentDiv = $('.content');
        var modal = $('.modal');

        $.ajax({
            url: url + '/Book/GetSearchDetails',
            type: 'POST',
            data: JSON.stringify(infoUrl),
            contentType: 'application/json',
            headers: {
                "Accept": "application/json",
            },
            success: function (data, textStatus, xhr) {

                if (data.authors !== null)
                    createHtmlListForAuthors(data.authors);

                if (data.exemplars !== null)
                    createHtmlTableFromJson(data.exemplars);

                if (data.title != null) {
                    $('#info-title').empty();
                    $('#info-title').append(data.title);
                }

                if (data.isbn != null) {
                    $('#info-isbn').empty();
                    $('#info-isbn').append('ISBN: ' + data.isbn);
                }

                $('div.is-collapsible p').each(function () {

                    let paragraph = $(this);

                    if (!paragraph.hasClass('is-hidden'))
                        paragraph.toggleClass('is-hidden');
                });

                if (data.publishingData != null) {
                    $('#info-publish').empty();
                    $('#info-publish').append('<b>Botuar: </b>' + data.publishingData);
                    $('#info-publish').toggleClass('is-hidden');
                }

                if (data.physicalData != null) {
                    $('#info-physical-data').empty();
                    $('#info-physical-data').append('<b>Të dhëna fizike: </b>' + data.physicalData);
                    $('#info-physical-data').toggleClass('is-hidden');
                }

                if (data.notes != null) {
                    $('#info-notes').empty();
                    $('#info-notes').append('<b>Shënime: </b>' + data.notes);
                    $('#info-notes').toggleClass('is-hidden');
                }

                if (data.clasification != null) {
                    $('#info-clasification').empty();
                    $('#info-clasification').append('<b>Klasifikimi: </b>' + data.clasification);
                    $('#info-clasification').toggleClass('is-hidden');
                }

                if (data.serieTitle != null) {
                    $('#info-serie-title').empty();
                    $('#info-serie-title').append('<b>Titull Serie: </b>' + data.serieTitle);
                    $('#info-serie-title').toggleClass('is-hidden');
                }

                if (data.keywords != null) {
                    $('#info-keywords').empty();
                    $('#info-keywords').append('<b>Fjalët kyçe: </b>');
                    $('#info-keywords').toggleClass('is-hidden');

                    data.keywords.forEach(element => {
                        $('#info-keywords').append("<span class='tag is-link'>" + element + "</span> ");
                    });
                }

                modal.toggleClass('is-active')
            },
            error: function (xhr, status, error) {
                if (xhr.status == 404 || xhr.status == 0) {
                    errorDiv.append("<strong>" + "Couldn't reach API url" + "</strong>");
                }
                else {
                    errorDiv.append("<strong>" + xhr.responseText + "</strong>");
                }

                errorDiv.toggleClass('error-notification');
            },
            complete: function () {
                loader.removeClass('is-active');
            }
        });
    }

    function closeModalForm() {
        $('.modal').toggleClass('is-active')
    }

    function createHtmlTableFromJson(jsonObject) {

        // EXTRACT VALUE FOR HTML HEADER. 
        var col = [];
        for (var i = 0; i < jsonObject.length; i++) {
            for (var key in jsonObject[i]) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }

        var headerText = ['Numri i inventarit', 'Gjendja', 'Lloji i huazimit', 'Numri i vendit'];

        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");

        // add bulma class to table
        table.classList.add('table');

        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.
        var tr = table.insertRow(-1);

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");
            th.innerHTML = headerText[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < jsonObject.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = jsonObject[i][col[j]];
            }
        }

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("table-container");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
    }

    function createHtmlListForAuthors(listOfAuthors) {
        $('div.list').empty();
        $('div.list').append('<li class="list-item is-active">Autorët:</li>');

        listOfAuthors.forEach(element => {
            $('div.list').append("<li class='list-item'>" + element + "</li>");
        });
    }

    function toggleIsHidden() {
        $('.is-collapsible').toggleClass('is-hidden')
    }

</script>

</html>